#!/bin/sh
# Pre-commit hook with lint-staged
# Runs formatting, linting, and security checks on staged files

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}Running pre-commit checks...${NC}"
echo ""

# Check if gitleaks is installed (required for security scanning)
if ! command -v gitleaks >/dev/null 2>&1; then
    echo "${YELLOW}⚠ Warning: gitleaks is not installed${NC}"
    echo ""
    echo "Gitleaks scans for secrets in your code. Please install it:"
    echo "  macOS:   ${BLUE}brew install gitleaks${NC}"
    echo "  Linux:   Visit https://github.com/gitleaks/gitleaks#installing"
    echo "  Windows: Visit https://github.com/gitleaks/gitleaks#installing"
    echo ""
    echo "Continuing without secret scanning..."
    echo "To skip this warning in the future, use: ${YELLOW}git commit --no-verify${NC}"
    echo ""
fi

# Run lint-staged (handles formatting, linting, and gitleaks)
echo "${YELLOW}Running lint-staged on staged files...${NC}"
NX_TUI=false NX_DAEMON=false npx lint-staged

# Capture the exit code
LINT_STAGED_EXIT_CODE=$?

if [ $LINT_STAGED_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "${RED}✗ Lint-staged checks failed${NC}"
    echo ""
    echo "Common fixes:"
    echo "  • Lint/format errors: ${BLUE}npx nx lint:fix <project>${NC}"
    echo "  • Secrets detected: Remove secrets and use environment variables"
    echo ""
    echo "To commit anyway (not recommended): ${YELLOW}git commit --no-verify${NC}"
    exit 1
fi

echo "${GREEN}✓ Lint-staged passed${NC}"
echo ""

echo "${GREEN}✓ All pre-commit checks passed!${NC}"
exit 0
